AWSTemplateFormatVersion: '2010-09-09'
Description: 'Serverless backend for manga reader - Lambda, API Gateway, S3 (Neon PostgreSQL version)'

Parameters:
  EnvironmentName:
    Description: Environment name that will be prefixed to resource names
    Type: String
    Default: manga-reader

  LambdaRuntime:
    Description: Lambda runtime
    Type: String
    Default: python3.11

  DatabaseURL:
    Description: Neon PostgreSQL connection string (postgresql://user:password@host/dbname?sslmode=require)
    Type: String
    NoEcho: true

  NextJSURL:
    Description: Next.js frontend URL for cache revalidation (e.g., https://your-site.vercel.app)
    Type: String
    Default: ''

  RevalidationSecret:
    Description: Secret token for Next.js revalidation API authentication
    Type: String
    NoEcho: true
    Default: ''

Resources:
  # S3 Bucket for manga images
  MangaImagesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${EnvironmentName}-manga-images-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: false
        IgnorePublicAcls: true
        RestrictPublicBuckets: false
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET]
            AllowedOrigins: ['*']
            MaxAge: 3600

  # S3 Bucket Policy to allow CloudFront access via OAC
  MangaImagesBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref MangaImagesBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCloudFrontServicePrincipal
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub '${MangaImagesBucket.Arn}/*'
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub 'arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}'

  # CloudFront Origin Access Control for S3
  CloudFrontOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub '${EnvironmentName}-s3-oac'
        Description: OAC for manga images S3 bucket
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # CloudFront Distribution for serving manga images
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub '${EnvironmentName} manga images CDN'
        DefaultRootObject: ''
        HttpVersion: http2and3
        PriceClass: PriceClass_100
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt MangaImagesBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: ''
            OriginAccessControlId: !GetAtt CloudFrontOAC.Id
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # Managed-CachingOptimized
          ResponseHeadersPolicyId: 60669652-455b-4ae9-85a4-c4c02393f86c  # Managed-SimpleCORS

  # IAM Role for Lambda functions
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${EnvironmentName}-lambda-execution-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: MangaReaderLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectAcl
                  - s3:PutObject
                  - s3:PutObjectAcl
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:aws:s3:::${MangaImagesBucket}/*'
                  - !GetAtt MangaImagesBucket.Arn
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource: !GetAtt MangaEventsEventBus.Arn

  # Lambda function for manga API
  MangaApiFunction:
    Type: AWS::Lambda::Function
    DependsOn: LambdaExecutionRole
    Properties:
      FunctionName: !Sub '${EnvironmentName}-manga-api'
      Runtime: !Ref LambdaRuntime
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        ZipFile: |
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'headers': {
                      'Content-Type': 'application/json',
                      'Access-Control-Allow-Origin': '*',
                      'Access-Control-Allow-Headers': 'Content-Type',
                      'Access-Control-Allow-Methods': 'GET,POST,OPTIONS'
                  },
                  'body': json.dumps({'message': 'Manga API placeholder - update with actual code'})
              }
      Environment:
        Variables:
          DATABASE_URL: !Ref DatabaseURL
          S3_BUCKET: !Ref MangaImagesBucket
          ENVIRONMENT: !Ref EnvironmentName
          CLOUDFRONT_DOMAIN: !GetAtt CloudFrontDistribution.DomainName
          EVENTBRIDGE_BUS_NAME: !Ref MangaEventsEventBus
      Timeout: 30
      MemorySize: 256

  # API Gateway HTTP API
  MangaApiGateway:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub '${EnvironmentName}-manga-api'
      Description: 'HTTP API for manga reader backend'
      ProtocolType: HTTP
      CorsConfiguration:
        AllowOrigins:
          - '*'
        AllowMethods:
          - GET
          - POST
          - OPTIONS
        AllowHeaders:
          - Content-Type
          - Authorization
        MaxAge: 300

  # API Gateway Integration
  LambdaIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref MangaApiGateway
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${MangaApiFunction.Arn}/invocations'
      PayloadFormatVersion: '2.0'

  # API Gateway Routes
  GetMangaRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MangaApiGateway
      RouteKey: 'GET /manga'
      Target: !Sub 'integrations/${LambdaIntegration}'

  GetMangaByIdRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MangaApiGateway
      RouteKey: 'GET /manga/{id}'
      Target: !Sub 'integrations/${LambdaIntegration}'

  GetLatestMangaRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MangaApiGateway
      RouteKey: 'GET /manga/latest'
      Target: !Sub 'integrations/${LambdaIntegration}'

  GetMangaBySlugRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MangaApiGateway
      RouteKey: 'GET /manga/slug/{slug}'
      Target: !Sub 'integrations/${LambdaIntegration}'

  GetChapterBySlugRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MangaApiGateway
      RouteKey: 'GET /manga/slug/{slug}/chapter/{num}'
      Target: !Sub 'integrations/${LambdaIntegration}'

  GetMangaChaptersRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MangaApiGateway
      RouteKey: 'GET /manga/{id}/chapters'
      Target: !Sub 'integrations/${LambdaIntegration}'

  GetChapterRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MangaApiGateway
      RouteKey: 'GET /chapters/{id}'
      Target: !Sub 'integrations/${LambdaIntegration}'

  PostMangaRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MangaApiGateway
      RouteKey: 'POST /manga'
      Target: !Sub 'integrations/${LambdaIntegration}'

  PostChapterRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref MangaApiGateway
      RouteKey: 'POST /chapters'
      Target: !Sub 'integrations/${LambdaIntegration}'

  # API Gateway Stage
  ApiStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref MangaApiGateway
      StageName: !Ref EnvironmentName
      AutoDeploy: true
      DefaultRouteSettings:
        ThrottlingBurstLimit: 100
        ThrottlingRateLimit: 50

  # Lambda permission for API Gateway
  LambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref MangaApiFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${MangaApiGateway}/*/*'

  # CloudWatch Log Group for Lambda
  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${MangaApiFunction}'
      RetentionInDays: 14

  # CloudWatch Log Group for API Gateway
  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/apigateway/${EnvironmentName}-manga-api'
      RetentionInDays: 14

  # EventBridge Event Bus for manga events
  MangaEventsEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub '${EnvironmentName}-manga-events'

  # IAM Role for Invalidation Lambda
  InvalidationLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${EnvironmentName}-invalidation-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: InvalidationLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - cloudfront:CreateInvalidation
                Resource: !Sub 'arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}'

  # Invalidation Lambda function
  InvalidationFunction:
    Type: AWS::Lambda::Function
    DependsOn: InvalidationLambdaRole
    Properties:
      FunctionName: !Sub '${EnvironmentName}-invalidation'
      Runtime: !Ref LambdaRuntime
      Handler: invalidation_handler.lambda_handler
      Role: !GetAtt InvalidationLambdaRole.Arn
      Code:
        ZipFile: |
          import json
          def lambda_handler(event, context):
              print(f"Received event: {json.dumps(event)}")
              return {'statusCode': 200, 'body': 'Invalidation placeholder - update with actual code'}
      Environment:
        Variables:
          NEXTJS_URL: !Ref NextJSURL
          REVALIDATION_SECRET: !Ref RevalidationSecret
          CLOUDFRONT_DISTRIBUTION_ID: !Ref CloudFrontDistribution
      Timeout: 60
      MemorySize: 128

  # CloudWatch Log Group for Invalidation Lambda
  InvalidationLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${InvalidationFunction}'
      RetentionInDays: 14

  # EventBridge Rule to trigger Invalidation Lambda
  MangaEventsRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${EnvironmentName}-manga-events-rule'
      Description: Route manga events to invalidation Lambda
      EventBusName: !Ref MangaEventsEventBus
      EventPattern:
        source:
          - manga-reader
      State: ENABLED
      Targets:
        - Id: InvalidationLambdaTarget
          Arn: !GetAtt InvalidationFunction.Arn

  # Permission for EventBridge to invoke Invalidation Lambda
  InvalidationLambdaEventBridgePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref InvalidationFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt MangaEventsRule.Arn

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${MangaApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentName}'
    Export:
      Name: !Sub '${EnvironmentName}-Api-Endpoint'

  ApiId:
    Description: API Gateway ID
    Value: !Ref MangaApiGateway
    Export:
      Name: !Sub '${EnvironmentName}-Api-Id'

  LambdaFunctionName:
    Description: Lambda function name
    Value: !Ref MangaApiFunction
    Export:
      Name: !Sub '${EnvironmentName}-Lambda-Function-Name'

  LambdaFunctionArn:
    Description: Lambda function ARN
    Value: !GetAtt MangaApiFunction.Arn
    Export:
      Name: !Sub '${EnvironmentName}-Lambda-Function-Arn'

  S3BucketName:
    Description: S3 bucket name for manga images
    Value: !Ref MangaImagesBucket
    Export:
      Name: !Sub '${EnvironmentName}-S3-Bucket-Name'

  S3BucketArn:
    Description: S3 bucket ARN
    Value: !GetAtt MangaImagesBucket.Arn
    Export:
      Name: !Sub '${EnvironmentName}-S3-Bucket-Arn'

  CloudFrontDomain:
    Description: CloudFront distribution domain name for manga images
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub '${EnvironmentName}-CloudFront-Domain'

  CloudFrontDistributionId:
    Description: CloudFront distribution ID
    Value: !Ref CloudFrontDistribution
    Export:
      Name: !Sub '${EnvironmentName}-CloudFront-Distribution-Id'

  EventBusName:
    Description: EventBridge event bus name
    Value: !Ref MangaEventsEventBus
    Export:
      Name: !Sub '${EnvironmentName}-EventBus-Name'

  InvalidationFunctionName:
    Description: Invalidation Lambda function name
    Value: !Ref InvalidationFunction
    Export:
      Name: !Sub '${EnvironmentName}-Invalidation-Function-Name'
